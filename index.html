<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K-Pop 韓語沉浸式學習 (2025 穩定版)</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root { --bg-dark: #121212; --bg-panel: #1e1e1e; --primary: #ff007f; --secondary: #00e5ff; --text-main: #ffffff; --text-sub: #bbbbbb; --text-zh: #ffcc00; }
        body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Noto Sans KR', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .container { display: grid; grid-template-columns: 3fr 2fr; width: 100%; height: 100%; }
        .video-section { display: flex; flex-direction: column; justify-content: center; align-items: center; background: black; padding: 20px; }
        .input-area { width: 100%; max-width: 800px; margin-bottom: 15px; display: flex; gap: 10px; }
        #yt-url-input { flex: 1; padding: 10px; border-radius: 4px; border: 1px solid #333; background: #333; color: white; border: 1px solid var(--primary); }
        button.load-btn { padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        #player { width: 100%; max-width: 800px; aspect-ratio: 16/9; box-shadow: 0 0 20px rgba(255, 0, 127, 0.2); }
        .lyrics-section { background: var(--bg-panel); overflow-y: auto; padding: 20px; border-left: 1px solid #333; position: relative; }
        .lyrics-header { position: sticky; top: 0; background: var(--bg-panel); padding-bottom: 10px; margin-bottom: 20px; border-bottom: 2px solid var(--primary); z-index: 10; }
        .lyric-row { padding: 15px; margin-bottom: 10px; border-radius: 8px; transition: all 0.3s ease; opacity: 0.4; cursor: pointer; border-left: 3px solid transparent; }
        .lyric-row.active { opacity: 1; background: rgba(255, 0, 127, 0.1); border-left: 3px solid var(--primary); transform: scale(1.02); }
        .line-hangul { font-size: 1.6rem; font-weight: 700; margin-bottom: 6px; }
        .char-interactive { display: inline-block; padding: 0 2px; }
        .char-interactive:hover { color: var(--secondary); cursor: pointer; }
        .line-rom { font-size: 0.9rem; color: var(--text-sub); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: #252525; padding: 30px; border-radius: 16px; width: 300px; text-align: center; border: 1px solid var(--primary); }
        .big-char { font-size: 4rem; color: var(--secondary); display: block; cursor: pointer; }
        .jamo-card { background: #333; padding: 10px; margin: 5px; border-radius: 8px; cursor: pointer; }
        @media (max-width: 768px) { .container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <div class="video-section">
        <div class="input-area">
            <input type="text" id="yt-url-input" placeholder="貼上 YouTube 網址" value="https://www.youtube.com/watch?v=u5Dqj7hU4_c">
            <button class="load-btn" onclick="loadUserVideo()">載入影片與字幕</button>
        </div>
        <div id="player"></div>
    </div>
    <div class="lyrics-section" id="lyrics-container">
        <div class="lyrics-header">
            <h2>韓語沉浸學習</h2>
            <p id="status-msg">請輸入網址並點擊載入</p>
        </div>
    </div>
</div>

<div class="modal-overlay" id="deconstructor-modal">
    <div class="modal-content">
        <button onclick="closeModal()" style="float:right; color:white; background:none; border:none; cursor:pointer;">&times;</button>
        <h3>字母解構</h3>
        <span class="big-char" id="modal-char"></span>
        <div id="modal-jamo-grid" style="display:flex; justify-content:center;"></div>
    </div>
</div>

<!-- 引入羅馬拼音庫：讓自動抓取的歌詞也能有拼音 -->
<script src="https://cdn.jsdelivr.net/npm/aromanize@0.1.5/aromanize.min.js"></script>

<script>
    let lyricsData = [];
    let player;

    // 1. YouTube 網址解析
    function getID(url) {
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : null;
    }

    // 2. 核心功能：抓取官方字幕
    async function loadUserVideo() {
        const urlInput = document.getElementById('yt-url-input');
        const videoId = getID(urlInput.value.trim());
        if (!videoId) return alert("網址無效");

        if (player) player.loadVideoById(videoId);
        
        const status = document.getElementById('status-msg');
        status.innerText = "正在使用強效伺服器抓取字幕...";
        
        try {
            // 這個 API 會直接回傳 JSON 格式的字幕，繞過 YouTube 的封鎖
            // 使用公共中繼站，這通常比 GAS 爬蟲更穩定
            const apiUrl = `https://youtube-transcript-api.onrender.com/transcript?video_id=${videoId}`;
            
            const res = await fetch(apiUrl);
            if (!res.ok) throw new Error("伺服器繁忙或此影片無字幕");
            
            const data = await res.json();
            // data 格式通常是: [{ text: "...", start: 0, duration: 1 }, ...]

            if (!data || data.length === 0) throw new Error("抓取到的內容為空");

            lyricsData = data.map(item => {
                const rawText = item.text
                    .replace(/&amp;#39;/g, "'")
                    .replace(/&quot;/g, '"');
                return {
                    start: item.start,
                    end: item.start + item.duration,
                    text_ko: rawText,
                    // 自動生成拼音
                    text_rom: (typeof Aromanize !== 'undefined') ? Aromanize.romanize(rawText) : ""
                };
            });

            renderLyrics();
            status.innerText = "載入成功！";
            alert("字幕抓取成功！");

        } catch (err) {
            console.error(err);
            status.innerText = "失敗: " + err.message;
            
            // 最終 Fallback：如果連強效伺服器都失敗，我們引導使用者手動複製
            const manualText = confirm("自動抓取被 YouTube 封鎖。是否要使用「手動貼上」功能？");
            if (manualText) {
                const userLyrics = prompt("請前往 YouTube 開啟轉錄稿，複製文字後貼於此處：");
                if (userLyrics) parseManualLyrics(userLyrics);
            }
        }
    }

    // 支援手動貼上：即使 API 全滅也能用的保險功能
    function parseManualLyrics(text) {
        // 簡單解析: [00:12] 文字 或 純文字排列
        const lines = text.split('\n');
        lyricsData = lines.map((l, i) => ({
            start: i * 3, // 假定每行 3 秒，手動貼上時難以精準對時
            end: (i + 1) * 3,
            text_ko: l,
            text_rom: (typeof Aromanize !== 'undefined') ? Aromanize.romanize(l) : ""
        }));
        renderLyrics();
        document.getElementById('status-msg').innerText = "手動載入成功 (時間軸可能不精準)";
    }

    // 3. 介面渲染
    function renderLyrics() {
        const container = document.getElementById('lyrics-container');
        const rows = container.querySelectorAll('.lyric-row');
        rows.forEach(r => r.remove());

        lyricsData.forEach((line, index) => {
            const row = document.createElement('div');
            row.className = 'lyric-row';
            row.id = `line-${index}`;
            row.onclick = () => player.seekTo(line.start);

            let hangulHtml = '';
            for (let char of (line.text_ko || "")) {
                if (char.match(/[ㄱ-ㅎ|ㅏ-ㅣ|가-힣]/)) {
                    hangulHtml += `<span class="char-interactive" onclick="openDeconstructor(event, '${char}')">${char}</span>`;
                } else {
                    hangulHtml += char;
                }
            }

            row.innerHTML = `
                <div class="line-hangul">${hangulHtml}</div>
                <div class="line-rom">${line.text_rom}</div>
            `;
            container.appendChild(row);
        });
    }

    // 4. 韓字拆解邏輯
    function openDeconstructor(e, char) {
        e.stopPropagation();
        if (player) player.pauseVideo();
        
        const INITIALS = ["ㄱ", "ㄲ", "ㄴ", "ㄷ", "ㄸ", "ㄹ", "ㅁ", "ㅂ", "ㅃ", "ㅅ", "ㅆ", "ㅇ", "ㅈ", "ㅉ", "ㅊ", "ㅋ", "ㅌ", "ㅍ", "ㅎ"];
        const MEDIALS = ["ㅏ", "ㅐ", "ㅑ", "ㅒ", "ㅓ", "ㅔ", "ㅕ", "ㅖ", "ㅗ", "ㅘ", "ㅙ", "ㅚ", "ㅛ", "ㅜ", "ㅝ", "ㅞ", "ㅟ", "ㅠ", "ㅡ", "ㅢ", "ㅣ"];
        const FINALS = ["", "ㄱ", "ㄲ", "ㄳ", "ㄴ", "ㄵ", "ㄶ", "ㄷ", "ㄹ", "ㄺ", "ㄻ", "ㄼ", "ㄽ", "ㄾ", "ㄿ", "ㅀ", "ㅁ", "ㅂ", "ㅄ", "ㅅ", "ㅆ", "ㅇ", "ㅈ", "ㅊ", "ㅋ", "ㅌ", "ㅍ", "ㅎ"];

        const code = char.charCodeAt(0) - 0xAC00;
        const initial = INITIALS[Math.floor(code / 588)];
        const medial = MEDIALS[Math.floor((code % 588) / 28)];
        const final = FINALS[code % 28];

        document.getElementById('modal-char').innerText = char;
        const grid = document.getElementById('modal-jamo-grid');
        grid.innerHTML = `<div class="jamo-card" onclick="speak('${initial}')">${initial}</div>
                          <div class="jamo-card" onclick="speak('${medial}')">${medial}</div>`;
        if (final) grid.innerHTML += `<div class="jamo-card" onclick="speak('${final}')">${final}</div>`;
        
        document.getElementById('deconstructor-modal').style.display = 'flex';
    }

    function closeModal() { document.getElementById('deconstructor-modal').style.display = 'none'; }
    function speak(t) { 
        const u = new SpeechSynthesisUtterance(t); 
        u.lang = 'ko-KR'; 
        window.speechSynthesis.speak(u); 
    }

    // 5. YouTube 播放器與同步
    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
            height: '100%', width: '100%', videoId: 'u5Dqj7hU4_c',
            events: { 'onReady': () => setInterval(sync, 100) }
        });
    }

    function sync() {
        if (!player || !player.getCurrentTime) return;
        const time = player.getCurrentTime();
        lyricsData.forEach((line, i) => {
            const el = document.getElementById(`line-${i}`);
            if (time >= line.start && time < line.end) {
                if (!el.classList.contains('active')) {
                    document.querySelectorAll('.lyric-row.active').forEach(r => r.classList.remove('active'));
                    el.classList.add('active');
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        });
    }

    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    document.body.appendChild(tag);
</script>
</body>
</html>
